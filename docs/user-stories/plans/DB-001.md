# Plan de Implementación: [DB-001] Esquema Base de Datos: Usuarios

**Estado:** Completado

Este documento detalla el plan para implementar la estructura de datos necesaria para la gestión de usuarios y autenticación, correspondiente a la User Story US-001.

## Objetivos
- Actualizar el esquema de Prisma (`schema.prisma`) para reflejar los requerimientos del modelo de usuario.
- Generar y aplicar la migración inicial en la base de datos PostgreSQL.
- Asegurar que el cliente de Prisma esté actualizado y tipado correctamente.

## Pasos de Implementación

### 1. Actualización de `schema.prisma`
Modificar el archivo `apps/backend/prisma/schema.prisma` para definir los enumerados y el modelo `User` con sus mapeos a base de datos.

**Cambios propuestos:**
- **Enums:**
  - `Role`: ADMIN (Arquitecto), CLIENT (Cliente/Invitado).
  - `SubscriptionTier`: FREE, PRO.
- **Modelo User:**
  - Mapeo de campos camelCase (código) a snake_case (base de datos).
  - Campos de auditoría (`created_at`, `updated_at`).

```prisma
// apps/backend/prisma/schema.prisma

enum Role {
  ADMIN   // Arquitecto - Acceso total a gestión de proyectos
  CLIENT  // Cliente - Acceso restringido (guest)
}

enum SubscriptionTier {
  FREE
  PRO
}

model User {
  id               String           @id @default(uuid())
  email            String           @unique
  passwordHash     String           @map("password_hash")
  fullName         String?          @map("full_name")
  role             Role             @default(CLIENT)
  subscriptionTier SubscriptionTier @default(FREE) @map("subscription_tier")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  @@map("users") // Nombre de tabla en plural y minúsculas
}
```

### 2. Validación del Entorno
- Verificar que el servicio de base de datos (`trace_postgres`) esté activo en Docker.
- Verificar que la variable de entorno `DATABASE_URL` en `apps/backend/.env` apunte correctamente al contenedor.

### 3. Ejecución de Migración
Ejecutar el siguiente comando desde el directorio `apps/backend` para aplicar los cambios:

```bash
npx prisma migrate dev --name init_users
```

Este comando realizará lo siguiente:
1.  Creará un archivo SQL de migración en `prisma/migrations`.
2.  Ejecutará el SQL contra la base de datos PostgreSQL.
3.  Regenerará el cliente de Prisma (`node_modules/.prisma/client`) con los nuevos tipos.

### 4. Verificación

#### Verificación de Base de Datos
- Conectarse a la base de datos y verificar que la tabla `users` existe.
- Verificar que las columnas tienen los nombres correctos (`password_hash`, `subscription_tier`, etc.).
- Verificar que el índice único en `email` se ha creado.

#### Verificación de Código
- Crear un script de prueba rápida o verificar en el editor que `PrismaClient` expone correctamente el modelo `user` y los tipos `Role` y `SubscriptionTier`.

## Notas Adicionales
- Se ha optado por `ADMIN` para el rol de arquitecto para simplificar la gestión de permisos en el futuro, alineado con las especificaciones del ticket.
- `SubscriptionTier` se inicializa en `FREE` por defecto.
